<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obsidian 笔记搜索</title>
    <link rel="stylesheet" href="../vendor/bootstrap/css/bootstrap.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            margin: 0; 
            padding: 40px 20px; 
        }
        .search-container { 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
            border: 1px solid rgba(255, 255, 255, 0.18); 
        }

        #searchInput { 
            margin-bottom: 10px; 
            height: 40px; 
            font-size: 16px; 
        }
        #searchButton { 
            height: 40px; 
            font-size: 16px; 
            width: 100%; 
        }
        .search-results { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background-color: white; 
            border: 1px solid #ced4da; 
            border-radius: 0 0 8px 8px; 
            max-height: 400px; 
            overflow-y: auto; 
            z-index: 1000; 
            display: none; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        .results-header {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 500;
        }
        .result-item { 
            padding: 12px 15px; 
            cursor: pointer; 
            border-bottom: 1px solid #f1f3f5; 
            transition: background-color 0.2s ease; 
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item:hover { 
            background-color: #f8f9fa; 
            transform: translateX(2px); 
        }
        .result-title { 
            font-weight: 600; 
            font-size: 1em; 
            margin-bottom: 4px; 
            color: #212529;
        }
        .result-path { 
            font-size: 0.85em; 
            color: #6c757d; 
            margin-bottom: 4px;
        }
        .result-snippet {
            font-size: 0.85em;
            color: #495057;
            font-style: italic;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 0 2px;
            border-radius: 2px;
            font-weight: 500;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .loading-indicator { 
            padding: 10px; 
            text-align: center; 
            display: none; 
        }
        .search-group { 
            position: relative; 
        }
    </style>
</head>
<body>
    <div class="search-container">
        <!-- API配置区域 -->
        <div class="config-section mb-4">
            <button class="btn btn-secondary btn-block mb-2" id="toggleConfig">
                <i class="fas fa-cog mr-2"></i>API配置
            </button>
            <div class="config-panel" id="configPanel" style="display: none;">
                <div class="form-group">
                    <label for="apiUrl">API URL</label>
                    <input type="text" id="apiUrl" class="form-control" placeholder="http://127.0.0.1:27123">
                </div>
                <div class="form-group">
                    <label for="apiToken">API Token</label>
                    <input type="password" id="apiToken" class="form-control" placeholder="输入你的API Token">
                </div>
                <button class="btn btn-success btn-block" id="saveConfig">保存配置</button>
            </div>
        </div>
        
        <!-- 搜索范围控制 -->
        <div class="search-options mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchScope" id="searchTitle" value="title" checked>
                <label class="form-check-label" for="searchTitle">仅标题</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="searchScope" id="searchFull" value="full">
                <label class="form-check-label" for="searchFull">全文搜索</label>
            </div>
        </div>
        
        <!-- 搜索区域 -->
        <div class="search-group">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="输入关键词搜索Obsidian笔记...">
                <div class="input-group-append">
                    <button id="searchButton" class="btn btn-primary">搜索</button>
                </div>
            </div>
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span class="ml-2">搜索中...</span>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // 配置相关元素
            const toggleConfig = document.getElementById('toggleConfig');
            const configPanel = document.getElementById('configPanel');
            const apiUrlInput = document.getElementById('apiUrl');
            const apiTokenInput = document.getElementById('apiToken');
            const saveConfig = document.getElementById('saveConfig');
            const searchScopeRadios = document.querySelectorAll('input[name="searchScope"]');
            
            // 从本地存储加载配置
            let apiConfig = {
                url: localStorage.getItem('obsidianApiUrl') || 'http://127.0.0.1:27123',
                token: localStorage.getItem('obsidianApiToken') || 'f9611c5942d43bb2644fd3c37abab1514fc311483bc68956fdb849c8fad848b1'
            };
            
            // 初始化配置表单
            apiUrlInput.value = apiConfig.url;
            apiTokenInput.value = apiConfig.token;
            
            // 配置面板折叠/展开功能
            toggleConfig.addEventListener('click', function() {
                if (configPanel.style.display === 'none' || configPanel.style.display === '') {
                    configPanel.style.display = 'block';
                    toggleConfig.innerHTML = '<i class="fas fa-cog mr-2"></i>收起配置';
                } else {
                    configPanel.style.display = 'none';
                    toggleConfig.innerHTML = '<i class="fas fa-cog mr-2"></i>API配置';
                }
            });
            
            // 保存配置到本地存储
            saveConfig.addEventListener('click', function() {
                const url = apiUrlInput.value.trim();
                const token = apiTokenInput.value.trim();
                
                if (!url) {
                    alert('请输入API URL');
                    return;
                }
                
                apiConfig.url = url;
                apiConfig.token = token;
                
                localStorage.setItem('obsidianApiUrl', url);
                localStorage.setItem('obsidianApiToken', token);
                
                alert('配置已保存');
            });

            // 防抖函数
            function debounce(func, delay = 300) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // 高亮搜索关键词
            function highlightText(text, query) {
                if (!text || !query) return escapeHtml(text);
                
                // 创建正则表达式，忽略大小写
                const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
                return escapeHtml(text).replace(regex, '<span class="highlight">$1</span>');
            }
            
            // 转义正则表达式特殊字符
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // 显示搜索结果
            function displayResults(results) {
                const query = searchInput.value.trim();
                
                // 清空并重置搜索结果容器
                searchResults.innerHTML = '';
                
                if (!results || results.length === 0) {
                    searchResults.innerHTML = `
                        <div class="results-header">搜索结果</div>
                        <div class="result-item">无匹配结果</div>
                    `;
                    searchResults.style.display = 'block';
                    return;
                }

                // 添加结果数量统计
                let html = `<div class="results-header">找到 ${results.length} 个匹配结果</div>`;
                
                results.forEach(note => {
                    // 获取笔记标题，如果没有则使用文件名
                    const title = note.title || (note.path ? note.path.split('/').pop().split('.')[0] : '无标题笔记');
                    
                    // 构建结果项HTML
                    html += `
                        <div class="result-item" data-path="${note.path}">
                            <div class="result-title">${highlightText(title, query)}</div>
                            <div class="result-path">${escapeHtml(note.path)}</div>
                            ${note.content || note.snippet ? 
                                `<div class="result-snippet">${highlightText(note.content || note.snippet, query)}</div>` : ''
                            }
                        </div>
                    `;
                });
                
                searchResults.innerHTML = html;
                searchResults.style.display = 'block';

                // 使用事件委托处理结果项点击事件，提高性能
                searchResults.addEventListener('click', function(event) {
                    const resultItem = event.target.closest('.result-item');
                    if (resultItem) {
                        const notePath = resultItem.getAttribute('data-path');
                        openNote(notePath);
                    }
                });
            }

            // 打开笔记，调用Obsidian API实际打开笔记
            async function openNote(notePath) {
                if (!apiConfig.url || !apiConfig.token) {
                    showError('API配置错误', '请检查API URL和Token是否正确配置');
                    return;
                }

                try {
                    // 显示加载状态
                    loadingIndicator.style.display = 'block';
                    
                    // 调用API打开笔记
                    const response = await fetch(`${apiConfig.url}/vault/open`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiConfig.token}`,
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ path: notePath })
                    });

                    if (!response.ok) {
                        // 处理不同的HTTP状态码
                        switch (response.status) {
                            case 401:
                                throw new Error('认证失败: 请检查API Token是否正确');
                            case 403:
                                throw new Error('权限不足: 您没有执行此操作的权限');
                            case 404:
                                throw new Error('笔记不存在: 请检查笔记路径是否正确');
                            case 500:
                                throw new Error('服务器错误: Obsidian Local REST API插件可能出现问题');
                            default:
                                throw new Error(`打开笔记失败: ${response.status} ${response.statusText}`);
                        }
                    }
                    
                    // 隐藏搜索结果
                    searchResults.style.display = 'none';
                    
                    // 显示成功提示
                    const successMessage = document.createElement('div');
                    successMessage.className = 'alert alert-success mt-3';
                    successMessage.textContent = `已成功打开笔记: ${notePath}`;
                    successMessage.style.animation = 'fadeOut 3s forwards';
                    
                    // 添加到页面
                    document.querySelector('.search-container').appendChild(successMessage);
                    
                    // 3秒后自动移除成功提示
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.parentNode.removeChild(successMessage);
                        }
                    }, 3000);
                    
                } catch (error) {
                    console.error('打开笔记失败:', error);
                    
                    // 区分网络错误和其他错误
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        showError('网络错误', '无法连接到Obsidian Local REST API，请检查：1. API URL是否正确 2. Local REST API插件是否已启用 3. 防火墙是否允许访问');
                    } else {
                        showError('打开笔记失败', error.message);
                    }
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }

            // 获取当前选择的搜索范围
            function getSearchScope() {
                return Array.from(searchScopeRadios).find(radio => radio.checked).value;
            }

            // 显示错误信息
            function showError(message, details = '') {
                const errorMessage = details ? `${message}: ${details}` : message;
                
                // 创建错误提示元素
                const errorElement = document.createElement('div');
                errorElement.className = 'alert alert-danger mt-3';
                errorElement.textContent = errorMessage;
                errorElement.style.animation = 'fadeOut 5s forwards';
                
                // 添加到页面
                document.querySelector('.search-container').appendChild(errorElement);
                
                // 5秒后自动移除错误提示
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.parentNode.removeChild(errorElement);
                    }
                }, 5000);
            }

            // 调用Obsidian API搜索笔记
            async function searchNotes(query) {
                if (!apiConfig.url || !apiConfig.token) {
                    showError('API配置错误', '请检查API URL和Token是否正确配置');
                    return [];
                }

                try {
                    loadingIndicator.style.display = 'block';
                    const searchScope = getSearchScope();
                    
                    // 根据搜索范围构建请求参数
                    const requestBody = {
                        query: query,
                        contextLength: 20
                    };
                    
                    // 如果是仅标题搜索，可以添加相关参数（根据API文档调整）
                    if (searchScope === 'title') {
                        // 这里可以根据API文档添加仅标题搜索的参数
                        // 例如：requestBody.searchMode = 'title';
                    }
                    
                    const response = await fetch(`${apiConfig.url}/search/simple`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiConfig.token}`,
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        // 处理不同的HTTP状态码
                        switch (response.status) {
                            case 401:
                                throw new Error('认证失败: 请检查API Token是否正确');
                            case 403:
                                throw new Error('权限不足: 您没有执行此操作的权限');
                            case 404:
                                throw new Error('API端点不存在: 请检查API URL是否正确');
                            case 500:
                                throw new Error('服务器错误: Obsidian Local REST API插件可能出现问题');
                            default:
                                throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                        }
                    }

                    const data = await response.json();
                    return data.results || [];
                } catch (error) {
                    console.error('搜索失败:', error);
                    
                    // 区分网络错误和其他错误
                    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        showError('网络错误', '无法连接到Obsidian Local REST API，请检查：1. API URL是否正确 2. Local REST API插件是否已启用 3. 防火墙是否允许访问');
                    } else {
                        showError('搜索失败', error.message);
                    }
                    
                    return [];
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }

            // 转义HTML特殊字符
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // 执行搜索
            const performSearch = debounce(async function() {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }

                const results = await searchNotes(query);
                displayResults(results);
            });

            // 事件监听
            searchInput.addEventListener('input', performSearch);
            searchButton.addEventListener('click', performSearch);

            // 按Enter键搜索
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    performSearch();
                }
            });

            // 点击页面其他地方隐藏搜索结果
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.search-group')) {
                    searchResults.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>