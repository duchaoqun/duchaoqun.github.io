<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <base href="">

    <!--
    favicons generated with:
    <http://realfavicongenerator.net>

    if you want to generate your own favicon, use this custom path:
    /theme/ico/favicon/
    -->
    <link rel="apple-touch-icon" sizes="57x57" href="/theme/ico/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/theme/ico/favicon/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/theme/ico/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/theme/ico/favicon/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/theme/ico/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/theme/ico/favicon/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/theme/ico/favicon/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/theme/ico/favicon/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/theme/ico/favicon/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/theme/ico/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/theme/ico/favicon/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/theme/ico/favicon/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/theme/ico/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/theme/ico/favicon/manifest.json">
    <link rel="mask-icon" href="/theme/ico/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/theme/ico/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage" content="/theme/ico/favicon/mstile-144x144.png">
    <meta name="msapplication-config" content="/theme/ico/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    
    <script src="/theme/js/lib/jquery-1.11.3.js"></script>
    <link rel="stylesheet" type="text/css" href="/theme/css/uikit.min.css" />
    <!-- custom css -->
    <link rel="stylesheet" type="text/css" href="/theme/css/custom.min.css" />
    <!-- default pygment style is the 'default' style -->
    <link rel="stylesheet" type="text/css" href="/theme/css/pygment.min.css" />
    <script src="/theme/js/uikit.min.js"></script>
    <title>Aliyun - ram & sts | Chris's Blog</title>
  <meta name="tags" content="aliyun, java, RAM, STS" /> <meta name="description" content="使用阿里云的OSS的时候，在APP端需要使用STS的结构，这里记录一下。" /> <meta name="category" content="Article" /> 
  </head>
  <body>
<div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">
    <nav class="uk-navbar uk-margin-large-bottom">
        <a class="uk-navbar-brand uk-hidden-small" href="">Chris's Blog</a>
        <ul class="uk-navbar-nav uk-hidden-small">
      <li class="uk-active"><a href="/category/article.html">Article</a></li>
        </ul>
        <a href="#offcanvas" class="uk-navbar-toggle uk-visible-small" data-uk-offcanvas=""></a>
        <div class="uk-navbar-brand uk-navbar-center uk-visible-small">Chris's Blog</div>
    </nav>
    <div class="uk-grid" data-uk-grid-margin="">
        <main class="uk-width-medium-3-4">
<article>
<div class="uk-article">
    <header>
    <h1 class=" uk-article-title">
        <a href="/00003.html">Aliyun - RAM & STS</a>
    </h1>
    <p class="uk-article-meta">
    Published on   <time datetime="2020-04-01">周三 01 四月 2020</time>
        by         <a class="url fn" href="/author/chris.html">Chris</a>
    posted in <a href="/category/article.html">Article</a>
    <br/>
    <a href="/tag/aliyun.html" class="uk-icon-tag">aliyun</a>
    <a href="/tag/java.html" class="uk-icon-tag">java</a>
    <a href="/tag/ram.html" class="uk-icon-tag">RAM</a>
    <a href="/tag/sts.html" class="uk-icon-tag">STS</a>

    </p>
    </header>
    <h2>RAM 创建用户</h2>
<ol>
<li>登录https://ram.console.aliyun.com/</li>
<li>在 <code>用户管理</code> 功能中，新建一个 <code>duchaoqun</code> 用户，记录 <code>AccessKeyID</code> 和 <code>AccessKeySecret</code>。</li>
<li>点击用户进入 <code>用户授权策略</code> 添加一个权限 <code>AliyunSTSAssumeRoleAccess</code>。</li>
<li>在 <code>角色管理</code> 里面，再创建一个 <code>duchaoqun</code> 的角色，记录 <code>Arn</code> 字符串，最后给这个角色授权 <code>AliyunOSSFullAccess</code>。</li>
</ol>
<h2>App-Token-Server</h2>
<p>说明：在 app-token-server 上配置用户和角色的信息，然后APP再发起请求的时候，返回临时的权限。</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;AccessKeyID&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;AccessKeySecret&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;RoleArn&quot;</span><span class="p">:</span> <span class="s2">&quot;acs:ram::&quot;</span><span class="p">,</span>
  <span class="nt">&quot;TokenExpireTime&quot;</span><span class="p">:</span> <span class="s2">&quot;3600&quot;</span><span class="p">,</span>
  <span class="nt">&quot;PolicyFile&quot;</span><span class="p">:</span> <span class="s2">&quot;policy/bucket_write_policy.txt&quot;</span>
<span class="p">}</span>
</code></pre></div>


<ul>
<li>AccessKeyID：填写用户的AccessKeyID。</li>
<li>AccessKeySecret：填写用户的AccessKeySecret。</li>
<li>RoleArn：填写角色的RoleArn。</li>
<li>TokenExpireTime：指Android/iOS应用取到这个Token的失效时间，注意，最少是900s，默认值可以不修改。</li>
<li>PolicyFile：填写的是该Token所要拥有的权限列表的文件，默认值可以不修改。</li>
</ul>
<p>三种最常用token权限文件，放于policy目录下面。分别是:
 - all_policy.txt：指定了该token拥有对该账号下创建Bucket、删除Bucket、上传文件、下载文件、删除文件的权限 。
 - bucket_read_policy.txt：指定了该token拥有该账号下对指定Bucket的读权限。
 - bucket_read_write_policy.txt：指定了该token拥有该账号下对指定Bucket的读写权限。
 - 如果您想要指定这个Token只能对指定的bucket有读写权限， 请把（bucket_read_policy.txt、 bucket_read_write_policy.txt）这些文件里面$BUCKET_NAME直接替换成指定的bucket名字。</p>
<p>在我们指定的服务器上启动服务：<code>java -jar oss-token-server.jar [port]</code></p>
<p>返回的数据内容：</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;200&quot;</span><span class="p">,</span>
  <span class="nt">&quot;AccessKeyId&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;AccessKeySecret&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Expiration&quot;</span><span class="p">:</span><span class="s2">&quot;2020-04-01T03:42:11Z&quot;</span>
<span class="p">}</span>
</code></pre></div>


<h2>Server 相应问题</h2>
<ol>
<li>
<p>ErrorCode: NoPermission ErrorMessage: Roles may not be assumed by root accounts.
    使用主用户的密钥调用AssumeRole，请使用子用户的密钥。</p>
</li>
<li>
<p>ErrorCode: MissingSecurityToken ErrorMessage: SecurityToken is mandatory for this action.
    使用临时用户的密钥调用AssumeRole，请使用子用户的密钥。</p>
</li>
<li>
<p>Error code: InvalidAccessKeyId.NotFound Error message: Specified access key is not found.
    AccessKeyId无效，请检查是否写错，特别是前后不能后空格。</p>
</li>
<li>
<p>Error code: InvalidAccessKeyId.Inactive Error message: Specified access key is disabled.
    使用的子用户的密钥，已经被禁止，请启用密钥或更换密钥。 密钥是否被禁止，请控制台的“访问控制-&gt;用户管理-&gt;管理-&gt;用户详情-&gt;用户AccessKey”确认，并开启。</p>
</li>
<li>
<p>ErrorCode: InvalidParameter.PolicyGrammar ErrorMessage: The parameter Policy has not passed grammar check.
    角色扮演时指定的授权策略无效。AssumeRole时可以指定授权(Policy)，也可以不指定。如果指定授权策略，则临时用户的权限是指定的授权策略和角色权限的交集；如果不指定授权策略，临时用户的权限是角色的权限。报该错误时，请检查指定的授权策略Policy。不推荐临时用户扮演角色时指定授权策略。如果的确需要使用授权策略，强烈建使用 RAM Policy Editor 生成授权策略。</p>
</li>
<li>
<p>ErrorCode: InvalidParameter.RoleSessionName ErrorMessage: The parameter RoleSessionName is wrongly formed.
    角色扮演时指定RoleSessionName无效。此参数用来区分不同的Token，以标明谁在使用此Token，便于审计; 格式：^[a-zA-Z0-9.@-_]+$，2-32个字符，了解更多请参看 扮演角色操作接口。如命名a，1，abc*abc，忍者神龟等都是非法的</p>
</li>
<li>
<p>ErrorCode: InvalidParameter.DurationSeconds Error message: The Min/Max value of DurationSeconds is 15min/1hr.
    角色扮演时指定的过期时间无效，即AssumeRoleRequest.setDurationSeconds参数无效。角色扮演时可以指定过期时间，单位为秒，有效时间是900 ~ 3600，如assumeRoleRequest.setDurationSeconds(60L * 20); 20分钟内有效。</p>
</li>
<li>
<p>ErrorCode: NoPermission ErrorMessage: No permission perform sts:AssumeRole on this Role. Maybe you are not authorized to perform sts:AssumeRole or the specified role does not trust you
    原因1：AssumeRole的子用户没有权限，请给子用户授予AliyunSTSAssumeRoleAccess系统授权策略。请在“访问控制-&gt;用户管理-&gt;授权-&gt;可选授权策略名称”中给子用户授权AliyunSTSAssumeRoleAccess。
    原因2：申请角色扮演的子用户的云账号ID与角色的“受信云账号ID”不符，请角色创建者确认并修改。子用户的云账号ID，即创建子用户的主用户的ID；角色的云账号ID，即创建角色的主用户的云账号ID。请在如下位置确认修改 访问控制 -&gt; 角色管理 -&gt; 管理 -&gt; 角色详细 -&gt; 编辑基本信息 中确认修改。
    原因3:角色的类型错误，如果角色的类型分为“用户角色”和“服务角色”，服务角色不能使用AssumeRole扮演临时用户。</p>
</li>
</ol>
<h2>参考文档</h2>
<p>https://help.aliyun.com/document_detail/100624.html?spm=a2c4g.11186623.2.10.7fc6418bKdfMR6#concept-xzh-nzk-2gb
https://help.aliyun.com/document_detail/32093.html?spm=a2c4g.11186623.6.1181.16d52d71KXDHZE
https://www.lastupdate.net/4681.html</p>
<h2>About</h2>
<ul>
<li>企鹅号码：848408012</li>
<li>企鹅群号：465073050</li>
<li>私人邮箱：du.chao.qun@163.com</li>
<li>备注说明：欢迎联系交流，共同学习进步，转载请注明出处，谢谢。</li>
</ul>
</div>
</article>
        </main>
        <aside class="uk-width-medium-1-4">

  <div class="uk-panel uk-panel-box uk-text-center">
    <a href="/author/Chris.html">
      <img alt="A picture of the author of this content." class="uk-border-circle" src="/theme/img/author.jpg"/><h3>Chris</h3></a>
      <p>
      Hi there! My name is Chris Du, check out more <a href="">about me</a>.
      </p>
  </div>

  <div class="uk-panel">
      <h3 class="uk-panel-title">Social Links</h3>
      <div class="icons">
          <a href="https://github.com/duchaoqun" class="uk-icon-button uk-icon-justify uk-icon-github"></a>
          <a href="https://twitter.com/AoyedeMutou" class="uk-icon-button uk-icon-justify uk-icon-twitter"></a>
      </div>
  </div>

    <div class="uk-panel">
    <h3 class="uk-panel-title">Tags</h3>
    <ul class="uk-list uk-list-line">
          <li><a href="/tag/aliyun.html" class="uk-icon-tag">aliyun</a></li>
          <li><a href="/tag/java.html" class="uk-icon-tag">java</a></li>
          <li><a href="/tag/ram.html" class="uk-icon-tag">RAM</a></li>
          <li><a href="/tag/sts.html" class="uk-icon-tag">STS</a></li>
          <li><a href="/tag/linux.html" class="uk-icon-tag">linux</a></li>
          <li><a href="/tag/command.html" class="uk-icon-tag">command</a></li>
          <li><a href="/tag/git.html" class="uk-icon-tag">git</a></li>
          <li><a href="/tag/python.html" class="uk-icon-tag">python</a></li>
          <li><a href="/tag/pelican.html" class="uk-icon-tag">pelican</a></li>
    </ul>
    </div>


    <div class="uk-panel">
    <h3 class="uk-panel-title">Links</h3>
    <ul class="uk-list uk-list-line">
          <li><a href="http://baidu.com/" class="uk-icon-external-link">Baidu</a></li>
          <li><a href="http://python.org/" class="uk-icon-external-link">Python.org</a></li>
          <li><a href="http://jinja.pocoo.org/" class="uk-icon-external-link">Jinja2</a></li>
    </ul>
    </div>

        </aside>
    </div>
    <footer class="uk-margin-bottom uk-panel uk-panel-box uk-text-center uk-margin-large-top">
        © Copyright 2011 – Present, Chris Du.
    </footer>
</div>

<div id="offcanvas" class="uk-offcanvas">
    <div class="uk-offcanvas-bar">
        <ul class="uk-nav uk-nav-offcanvas">
      <li class="uk-active"><a href="/category/article.html">Article</a></li>
        </ul>
    </div>
</div>
  </body>
</html>